# CI/CD Integration

## GitHub Actions Setup

Vantage integrates with GitHub Actions to automatically run performance checks on pull requests and post results.

### Step 1: Create GitHub Personal Access Token

1. Go to GitHub Settings ‚Üí Developer settings ‚Üí Personal access tokens
2. Generate new token with scopes:
   - `repo` (for posting comments and setting status)
3. Save the token

### Step 2: Add Token to Repository Secrets

1. Go to your repository ‚Üí Settings ‚Üí Secrets and variables ‚Üí Actions
2. Click "New repository secret"
3. Name: `GITHUB_TOKEN`
4. Paste your PAT from Step 1
5. Save

### Step 3: Create Workflow File

The workflow file is already created at `.github/workflows/performance.yml`.

### Step 4: Configure Vantage

Add a `.vantage.yml` file to your repository root:

```yaml
framework: nextjs

bundle:
  analysis: deep
  outputDir: .next
  treemap: true
  budgets:
    - path: "app/**/*.js"
      max: 100kb
  thresholds:
    regression: 10
    warning: 5

runtime:
  routes:
    - /
    - /dashboard
  exclude:
    - "/api/**"
    - "/_next/**"
  thresholds:
    lcp: 2500
    inp: 200
    cls: 0.1
    lighthouse:
      numberOfRuns: 3
      preset: desktop
      throttling: fast-3g
```

### Step 5: Enable Branch Protection (Optional)

To require performance checks to pass before merging:

1. Go to repository ‚Üí Settings ‚Üí Branches
2. Add rule for `main` branch
3. Enable:
   - Require status checks to pass before merging
   - Add "vantage" status check to required checks

## Workflow Triggers

The workflow runs on:
- **Pull requests**: When PRs are opened, synchronized, or reopened
- **Push to main/develop**: For continuous monitoring

## What the Workflow Does

1. **Checkout** - Pulls your code
2. **Setup Node.js** - Installs Node 18 with npm caching
3. **Install dependencies** - Runs `npm ci`
4. **Run performance checks** - Executes `vantage check`
5. **Post results to PR** - Comments on PR with metrics table
6. **Set status check** - Updates GitHub status with pass/fail
7. **Upload artifacts** - Saves detailed results as artifacts

## PR Comment Format

The workflow will post a comment like this:

```markdown
## Performance Results

### Runtime Metrics

| Metric | Value | Status |
|--------|-------|--------|
| LCP (/) | 1200ms | ‚úÖ |
| INP (/) | 45ms | ‚úÖ |
| CLS (/) | 0.05 | ‚úÖ |
| Score (/) | 95 | ‚úÖ |

### Bundle Analysis

| Metric | Value |
|--------|-------|
| Size | 245KB |
| Change | +15KB üìà |
| Status | ‚ö†Ô∏è |

---

*Generated by Vantage*
```

## Status Checks

The workflow sets a status check on commits:
- **success** - All performance checks passed
- **failure** - Performance thresholds exceeded

## Artifacts

Detailed performance results are uploaded as GitHub Actions artifacts:
- Navigate to Actions ‚Üí Workflow run ‚Üí Artifacts
- Download `performance-results` artifact
- Contains:
  - Lighthouse reports
  - Bundle analysis results
  - Treemap visualizations
  - Performance metrics JSON

## Troubleshooting

### PR Comment Not Appearing

- Check that `GITHUB_TOKEN` secret is set
- Verify the token has `repo` scope
- Check Actions logs for errors

### Status Check Not Updating

- Ensure `GITHUB_TOKEN` has correct permissions
- Check workflow logs for API errors

### Build Failing

- Verify Next.js is building correctly
- Check that `.next/` directory exists after build
- Ensure Lighthouse can access your URLs

## Customization

### Changing Routes Tested

Edit `runtime.routes` in `.vantage.yml`:

```yaml
runtime:
  routes:
    - /
    - /about
    - /products/[id]
```

### Adjusting Thresholds

Modify `runtime.thresholds`:

```yaml
runtime:
  thresholds:
    lcp: 2000      # Stricter: 2s instead of 2.5s
    inp: 150        # Stricter: 150ms instead of 200ms
    cls: 0.05       # Stricter: 0.05 instead of 0.1
```

### Adding Bundle Budgets

Edit `bundle.budgets`:

```yaml
bundle:
  budgets:
    - path: "app/**/*.js"
      max: 50kb
    - path: "chunks/vendor-*.js"
      max: 200kb
```

## Additional CI Platforms

### GitLab CI (Planned)

Support for GitLab CI is planned for v2.0.

### Bitbucket Pipelines (Planned)

Support for Bitbucket Pipelines is planned for v2.0.

## Best Practices

1. **Run on multiple presets**: Test both desktop and mobile
2. **Use median values**: Reduces false positives from network variance
3. **Set appropriate thresholds**: Based on your application's needs
4. **Review trends**: Monitor performance over time, not just individual builds
5. **Act on regressions**: Address performance regressions before merging
6. **Keep documentation updated**: Document performance goals for your team

## Example Workflow with Matrix

To test multiple configurations:

```yaml
jobs:
  performance:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        preset: [desktop, mobile]
        throttling: [fast-3g, slow-4g]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: |
          npx vantage check
        env:
          TEST_PRESET: ${{ matrix.preset }}
          TEST_THROTTLING: ${{ matrix.throttling }}
```
